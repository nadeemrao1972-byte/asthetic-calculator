!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="ede0081d-4487-4640-8898-fa8fa8f5c3a5",e._sentryDebugIdIdentifier="sentry-dbid-ede0081d-4487-4640-8898-fa8fa8f5c3a5")}catch(e){}}();var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"ef5ff8f4"};"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7268],{3181:(e,t,s)=>{var n;s.d(t,{v:()=>n}),function(e){e[e.INTERNAL=0]="INTERNAL",e[e.SERVER=1]="SERVER",e[e.CLIENT=2]="CLIENT",e[e.PRODUCER=3]="PRODUCER",e[e.CONSUMER=4]="CONSUMER"}(n||(n={}))},22847:(e,t,s)=>{let n;s.d(t,{yU:()=>L,O9:()=>O,uq:()=>H,Bi:()=>_,bH:()=>R,vL:()=>I,xH:()=>J,UU:()=>G,f2:()=>Y,_I:()=>q,iH:()=>P,mH:()=>B,$C:()=>k,oG:()=>F,EK:()=>j,sE:()=>D,YD:()=>N,ug:()=>T,o0:()=>Z,rE:()=>Q});var i=s(74651);let o=e=>crypto.getRandomValues(new Uint8Array(e));var r=s(68069),a=s(57010),h=s(91630),l=s(3181),d=s(97858),c=s(16128),u="UNEXPECTED_DISCONNECT",g="CANCEL",f=e=>i.ZU.Object({ok:i.ZU.Literal(!1),payload:e}),p=i.ZU.Object({path:i.ZU.String(),message:i.ZU.String()});i.ZU.Array(p);var y=i.ZU.Object({code:i.ZU.Literal(g),message:i.ZU.String()});f(y);var m=i.ZU.Union([i.ZU.Object({code:i.ZU.Literal("UNCAUGHT_ERROR"),message:i.ZU.String()}),i.ZU.Object({code:i.ZU.Literal(u),message:i.ZU.String()}),i.ZU.Object({code:i.ZU.Literal("INVALID_REQUEST"),message:i.ZU.String(),extras:i.ZU.Optional(i.ZU.Object({firstValidationErrors:i.ZU.Array(p),totalErrors:i.ZU.Number()}))}),y]),w=f(m),v=i.ZU.Union([i.ZU.Object({ok:i.ZU.Literal(!1),payload:i.ZU.Object({code:i.ZU.String(),message:i.ZU.String(),extras:i.ZU.Optional(i.ZU.Unknown())})}),i.ZU.Object({ok:i.ZU.Literal(!0),payload:i.ZU.Unknown()})]);function b(e){return{ok:!1,payload:e}}var E={code:"READABLE_BROKEN",message:"Readable was broken before it is fully consumed"},S=class{closed=!1;locked=!1;broken=!1;brokenWithValuesLeftToRead=!1;queue=[];next=null;[Symbol.asyncIterator](){if(this.locked)throw TypeError("Readable is already locked");this.locked=!0;let e=!1;return{next:async()=>{if(e)return{done:!0,value:void 0};for(;0===this.queue.length;){if(this.closed&&!this.brokenWithValuesLeftToRead)return{done:!0,value:void 0};if(this.broken)return e=!0,{done:!1,value:b(E)};this.next||(this.next=function(){let e,t;return{promise:new Promise((s,n)=>{e=s,t=n}),resolve:e,reject:t}}()),await this.next.promise,this.next=null}return{done:!1,value:this.queue.shift()}},return:async()=>(this.break(),{done:!0,value:void 0})}}async collect(){let e=[];for await(let t of this)e.push(t);return e}break(){this.broken||(this.locked=!0,this.broken=!0,this.brokenWithValuesLeftToRead=this.queue.length>0,this.queue.length=0,this.next?.resolve())}isReadable(){return!this.locked&&!this.broken}_pushValue(e){if(!this.broken){if(this.closed)throw Error("Cannot push to closed Readable");this.queue.push(e),this.next?.resolve()}}_triggerClose(){if(this.closed)throw Error("Unexpected closing multiple times");this.closed=!0,this.next?.resolve()}_hasValuesInQueue(){return this.queue.length>0}isClosed(){return this.closed}},C=class{writeCb;closeCb;closed=!1;constructor(e){this.writeCb=e.writeCb,this.closeCb=e.closeCb}write(e){if(this.closed)throw Error("Cannot write to closed Writable");this.writeCb(e)}isWritable(){return!this.closed}close(e){this.closed||(void 0!==e&&this.writeCb(e),this.closed=!0,this.writeCb=()=>void 0,this.closeCb(),this.closeCb=()=>void 0)}isClosed(){return this.closed}},U=((e,t=21)=>((e,t,s)=>{let n=(2<<Math.log2(e.length-1))-1,i=-~(1.6*n*t/e.length);return (o=t)=>{let r="";for(;;){let t=s(i),a=0|i;for(;a--;)if((r+=e[t[a]&n]||"").length>=o)return r}}})(e,0|t,o))("1234567890abcdefghijklmnopqrstuvxyzABCDEFGHIJKLMNOPQRSTUVXYZ"),k=()=>U(12),x=i.ZU.Object({type:i.ZU.Literal("ACK")}),M=i.ZU.Object({type:i.ZU.Literal("CLOSE")}),B="v2.0",I=["v1.1",B];function T(e){return I.includes(e)}var L=i.ZU.Object({type:i.ZU.Literal("HANDSHAKE_REQ"),protocolVersion:i.ZU.String(),sessionId:i.ZU.String(),expectedSessionState:i.ZU.Object({nextExpectedSeq:i.ZU.Integer(),nextSentSeq:i.ZU.Integer()}),metadata:i.ZU.Optional(i.ZU.Unknown())}),_=i.ZU.Union([i.ZU.Literal("SESSION_STATE_MISMATCH")]),H=i.ZU.Union([i.ZU.Literal("REJECTED_UNSUPPORTED_CLIENT"),i.ZU.Literal("REJECTED_BY_CUSTOM_HANDLER")]),$=i.ZU.Union([H,i.ZU.Literal("MALFORMED_HANDSHAKE_META"),i.ZU.Literal("MALFORMED_HANDSHAKE"),i.ZU.Literal("PROTOCOL_VERSION_MISMATCH")]),A=i.ZU.Union([_,$]),O=i.ZU.Object({type:i.ZU.Literal("HANDSHAKE_RESP"),status:i.ZU.Union([i.ZU.Object({ok:i.ZU.Literal(!0),sessionId:i.ZU.String()}),i.ZU.Object({ok:i.ZU.Literal(!1),reason:i.ZU.String(),code:A})])});i.ZU.Union([M,x,L,O]);var R=(n=i.ZU.Unknown(),i.ZU.Object({id:i.ZU.String(),from:i.ZU.String(),to:i.ZU.String(),seq:i.ZU.Integer(),ack:i.ZU.Integer(),serviceName:i.ZU.Optional(i.ZU.String()),procedureName:i.ZU.Optional(i.ZU.String()),streamId:i.ZU.String(),controlFlags:i.ZU.Integer(),tracing:i.ZU.Optional(i.ZU.Object({traceparent:i.ZU.String(),tracestate:i.ZU.String()})),payload:n}));function D({from:e,to:t,sessionId:s,expectedSessionState:n,metadata:i,tracing:o}){return{id:k(),from:e,to:t,seq:0,ack:0,streamId:k(),controlFlags:0,tracing:o,payload:{type:"HANDSHAKE_REQ",protocolVersion:B,sessionId:s,expectedSessionState:n,metadata:i}}}function N({from:e,to:t,status:s}){return{id:k(),from:e,to:t,seq:0,ack:0,streamId:k(),controlFlags:0,payload:{type:"HANDSHAKE_RESP",status:s}}}function Z(e){return(1&e)==1}function F(e){let t={traceparent:"",tracestate:""};return r.$.inject(e,t),t}function P(e,t,s,n,i){let o=i?r.$.extract(a._.active(),i):a._.active(),l=e.startSpan("river.session",{attributes:{component:"river","river.session.id":t,"river.session.to":s,"river.session.from":n}},o),d=h.u.setSpan(o,l);return{span:l,ctx:d}}function q(e,t,s){let n=e.startSpan("river.connection",{attributes:{component:"river","river.connection.id":t.id},links:[{context:s.span.spanContext()}]},s.ctx),i=h.u.setSpan(s.ctx,n);return{span:n,ctx:i}}function j(){return h.u.getTracer("river",Q)}var z=()=>{},V={connectOnInvoke:!0,eagerlyConnect:!0};function G(e,t,s={}){s.handshakeOptions&&e.extendHandshake(s.handshakeOptions);let n={...V,...s};return n.eagerlyConnect&&e.connect(t),function e(t,s){return new Proxy(z,{get(n,i){if("string"==typeof i)return e(t,[...s,i])},apply:(e,n,i)=>t({path:s,args:i})})}(s=>{let[i,o,r]=[...s.path];if(!(i&&o&&r))throw Error("invalid river call, ensure the service and procedure you are calling exists");let[f,p]=s.args;if(n.connectOnInvoke&&!e.sessions.has(t)&&e.connect(t),"rpc"!==r&&"subscribe"!==r&&"stream"!==r&&"upload"!==r)throw Error(`invalid river call, unknown procedure type ${r}`);return function(e,t,s,n,i,o,r){if("closed"===t.getStatus()){var f=e;let t=new S,s=b({code:u,message:"transport is closed"});t._pushValue(s),t._triggerClose();let n=new C({writeCb:()=>{},closeCb:()=>{}});return n.close(),K(f,t,n)}let p=t.sessions.get(s)??t.createUnconnectedSession(s),y=t.getSessionBoundSendFn(s,p.id),m="rpc"===e||"subscription"===e,E=k(),{span:U,ctx:x}=function(e,t,s,n,i,o){let r=a._.active(),d=e.startSpan(`river.client.${n}.${i}`,{attributes:{component:"river","river.method.kind":s,"river.method.service":n,"river.method.name":i,"river.streamId":o,"span.kind":"client"},links:[{context:t.telemetry.span.spanContext()}],kind:l.v.CLIENT},r),c=h.u.setSpan(r,d),u={...t.loggingMetadata,transportMessage:{procedureName:i,serviceName:n}};return d.isRecording()&&(u.telemetry={traceId:d.spanContext().traceId,spanId:d.spanContext().spanId}),t.log?.info(`invoked ${n}.${i}`,u),{span:d,ctx:c}}(t.tracer,p,e,i,o,E),B=!0,I=new C({writeCb:e=>{y({streamId:E,payload:e,controlFlags:0})},closeCb:()=>{U.addEvent("reqWritable closed"),!m&&B&&y({streamId:E,controlFlags:8,payload:{type:"CLOSE"}}),T.isClosed()&&_()}}),T=new S,L=()=>{T._triggerClose(),U.addEvent("resReadable closed"),I.isClosed()&&_()};function _(){t.removeEventListener("message",$),t.removeEventListener("sessionStatus",A),r?.removeEventListener("abort",H),U.end()}function H(){!(T.isClosed()&&I.isClosed())&&(U.addEvent("sending cancel"),B=!1,T.isClosed()||(T._pushValue(b({code:g,message:"cancelled by client"})),L()),I.close(),y({streamId:E,controlFlags:4,payload:b({code:g,message:"cancelled by client"})}))}function $(e){if(e.streamId===E){if(e.to!==t.clientId)return void t.log?.error("got stream message from unexpected client",{clientId:t.clientId,transportMessage:e});if((4&e.controlFlags)==4){let s;B=!1,U.addEvent("received cancel"),d.J(w,e.payload)?s=e.payload:(s=b({code:g,message:"stream cancelled with invalid payload"}),t.log?.warn("got stream cancel without a valid protocol error",{clientId:t.clientId,transportMessage:e,validationErrors:[...c.I(w,e.payload)]})),T.isClosed()||(T._pushValue(s),L()),I.close();return}if(T.isClosed()){U.recordException("received message after response stream is closed"),t.log?.error("received message after response stream is closed",{clientId:t.clientId,transportMessage:e});return}d.J(M,e.payload)||(d.J(v,e.payload)?T._pushValue(e.payload):t.log?.error("Got non-control payload, but was not a valid result",{clientId:t.clientId,transportMessage:e,validationErrors:[...c.I(v,e.payload)]})),(8&e.controlFlags)==8&&(U.addEvent("received response close"),T.isClosed()?t.log?.error("received stream close but readable was already closed"):L())}}function A(e){"closing"===e.status&&e.session.to===s&&p.id===e.session.id&&(B=!1,T.isClosed()||(T._pushValue(b({code:u,message:`${s} unexpectedly disconnected`})),L()),I.close())}return r?.addEventListener("abort",H),t.addEventListener("message",$),t.addEventListener("sessionStatus",A),y({streamId:E,serviceName:i,procedureName:o,tracing:F(x),payload:n,controlFlags:m?10:2}),m&&I.close(),K(e,T,I,t.log)}("subscribe"===r?"subscription":r,e,t,f,i,o,p?p.signal:void 0)},[])}function K(e,t,s,n){if("subscription"===e)return{resReadable:t};if("rpc"===e)return W(t,n);if("upload"===e){let e=!1;return{reqWritable:s,finalize:()=>{if(e)throw Error("upload stream already finalized");return e=!0,s.isClosed()||s.close(),W(t,n)}}}return{resReadable:t,reqWritable:s}}async function W(e,t){let s=await e.collect();return s.length>1&&t?.error("Expected single message from server, got multiple"),s[0]}function J(e){return e instanceof Error?e.message||"unknown reason":`[coerced to error] ${String(e)}`}function Y(e,t){return{schema:e,construct:t}}var Q="0.209.8"},30977:(e,t,s)=>{s.d(t,{B:()=>d,L:()=>l});var n=s(81720),i=function(e,t){var s="function"==typeof Symbol&&e[Symbol.iterator];if(!s)return e;var n,i,o=s.call(e),r=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)r.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(s=o.return)&&s.call(o)}finally{if(i)throw i.error}}return r},o=function(e){var t="function"==typeof Symbol&&Symbol.iterator,s=t&&e[t],n=0;if(s)return s.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},r=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map(function(e){var t=i(e,2);return[t[0],t[1]]})},e.prototype.setEntry=function(t,s){var n=new e(this._entries);return n._entries.set(t,s),n},e.prototype.removeEntry=function(t){var s=new e(this._entries);return s._entries.delete(t),s},e.prototype.removeEntries=function(){for(var t,s,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var r=new e(this._entries);try{for(var a=o(n),h=a.next();!h.done;h=a.next()){var l=h.value;r._entries.delete(l)}}catch(e){t={error:e}}finally{try{h&&!h.done&&(s=a.return)&&s.call(a)}finally{if(t)throw t.error}}return r},e.prototype.clear=function(){return new e},e}(),a=Symbol("BaggageEntryMetadata"),h=n.K.instance();function l(e){return void 0===e&&(e={}),new r(new Map(Object.entries(e)))}function d(e){return"string"!=typeof e&&(h.error("Cannot create baggage metadata from unknown type: "+typeof e),e=""),{__TYPE__:a,toString:function(){return e}}}},46308:(e,t,s)=>{var n;s.d(t,{s:()=>n}),function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"}(n||(n={}))},57010:(e,t,s)=>{s.d(t,{_:()=>n});var n=s(6639)._.getInstance()},68069:(e,t,s)=>{s.d(t,{$:()=>m});var n=s(7079),i=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),o={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},r={set:function(e,t,s){null!=e&&(e[t]=s)}},a=s(6639),h=(0,s(3107).n)("OpenTelemetry Baggage Key");function l(e){return e.getValue(h)||void 0}function d(){return l(a._.getInstance().active())}function c(e,t){return e.setValue(h,t)}function u(e){return e.deleteValue(h)}var g=s(30977),f=s(81720),p="propagation",y=new i,m=(function(){function e(){this.createBaggage=g.L,this.getBaggage=l,this.getActiveBaggage=d,this.setBaggage=c,this.deleteBaggage=u}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return(0,n.$G)(p,e,f.K.instance())},e.prototype.inject=function(e,t,s){return void 0===s&&(s=r),this._getGlobalPropagator().inject(e,t,s)},e.prototype.extract=function(e,t,s){return void 0===s&&(s=o),this._getGlobalPropagator().extract(e,t,s)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){(0,n.kv)(p,f.K.instance())},e.prototype._getGlobalPropagator=function(){return(0,n.mS)(p)||y},e})().getInstance()},81044:(e,t,s)=>{s.d(t,{MU:()=>ei,xp:()=>eg,bd:()=>D,kc:()=>ep,Yb:()=>ey});var n=s(91630),i=s(57010);s(95570);var o={debug:-1,info:0,warn:1,error:2},r=e=>(t,s)=>{if(s&&!s.telemetry){let e=n.u.getSpan(i._.active());e&&(s.telemetry={traceId:e.spanContext().traceId,spanId:e.spanContext().spanId})}if(!s?.transportMessage)return void e(t,s);let{payload:o,...r}=s.transportMessage;s.transportMessage=r,e(t,s)},a=class{minLevel;output;constructor(e,t="info"){this.minLevel=t,this.output=e}debug(e,t){o[this.minLevel]<=o.debug&&this.output(e,t??{},"debug")}info(e,t){o[this.minLevel]<=o.info&&this.output(e,t??{},"info")}warn(e,t){o[this.minLevel]<=o.warn&&this.output(e,t??{},"warn")}error(e,t){o[this.minLevel]<=o.error&&this.output(e,t??{},"error")}},h=e=>({debug:r(e.debug.bind(e)),info:r(e.info.bind(e)),warn:r(e.warn.bind(e)),error:r(e.error.bind(e))}),l=s(22847),d=s(46308);class c{constructor(e,t){this.type=e,this.data=t}}class u extends Error{constructor(e){super(e),Object.setPrototypeOf(this,Object.create(u.prototype)),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:u.name})}}function g(e,t,s){let n=Math.floor(s/0x100000000);e.setUint32(t,n),e.setUint32(t+4,s)}function f(e,t){return 0x100000000*e.getInt32(t)+e.getUint32(t+4)}let p={type:-1,encode:function(e){return e instanceof Date?function({sec:e,nsec:t}){if(e>=0&&t>=0&&e<=0x3ffffffff)if(0===t&&e<=0xffffffff){let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e),t}else{let s=e/0x100000000,n=new Uint8Array(8),i=new DataView(n.buffer);return i.setUint32(0,t<<2|3&s),i.setUint32(4,0|e),n}{let s=new Uint8Array(12),n=new DataView(s.buffer);return n.setUint32(0,t),g(n,4,e),s}}(function(e){let t=e.getTime(),s=Math.floor(t/1e3),n=(t-1e3*s)*1e6,i=Math.floor(n/1e9);return{sec:s+i,nsec:n-1e9*i}}(e)):null},decode:function(e){let t=function(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:{let e=t.getUint32(0);return{sec:(3&e)*0x100000000+t.getUint32(4),nsec:e>>>2}}case 12:return{sec:f(t,4),nsec:t.getUint32(0)};default:throw new u(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${e.length}`)}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}};class y{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(p)}register({type:e,encode:t,decode:s}){if(e>=0)this.encoders[e]=t,this.decoders[e]=s;else{let n=-1-e;this.builtInEncoders[n]=t,this.builtInDecoders[n]=s}}tryToEncode(e,t){for(let s=0;s<this.builtInEncoders.length;s++){let n=this.builtInEncoders[s];if(null!=n){let i=n(e,t);if(null!=i)return new c(-1-s,i)}}for(let s=0;s<this.encoders.length;s++){let n=this.encoders[s];if(null!=n){let i=n(e,t);if(null!=i)return new c(s,i)}}return e instanceof c?e:null}decode(e,t,s){let n=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return n?n(e,t,s):new c(t,e)}}y.defaultCodec=new y;let m=new TextEncoder;function w(e,t,s){let n=t,i=n+s,o=[],r="";for(;n<i;){let t=e[n++];if((128&t)==0)o.push(t);else if((224&t)==192){let s=63&e[n++];o.push((31&t)<<6|s)}else if((240&t)==224){let s=63&e[n++],i=63&e[n++];o.push((31&t)<<12|s<<6|i)}else if((248&t)==240){let s=63&e[n++],i=(7&t)<<18|s<<12|(63&e[n++])<<6|63&e[n++];i>65535&&(i-=65536,o.push(i>>>10&1023|55296),i=56320|1023&i),o.push(i)}else o.push(t);o.length>=4096&&(r+=String.fromCharCode(...o),o.length=0)}return o.length>0&&(r+=String.fromCharCode(...o)),r}let v=new TextDecoder;function b(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer||"undefined"!=typeof SharedArrayBuffer&&e instanceof SharedArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}class E{constructor(e){this.entered=!1,this.extensionCodec=e?.extensionCodec??y.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.maxDepth=e?.maxDepth??100,this.initialBufferSize=e?.initialBufferSize??2048,this.sortKeys=e?.sortKeys??!1,this.forceFloat32=e?.forceFloat32??!1,this.ignoreUndefined=e?.ignoreUndefined??!1,this.forceIntegerToFloat=e?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new E({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw Error(`Too deep objects in depth ${t}`);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.useBigInt64&&"bigint"==typeof e?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){let t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)}resizeBuffer(e){let t=new ArrayBuffer(e),s=new Uint8Array(t),n=new DataView(t);s.set(this.bytes),this.view=n,this.bytes=s}encodeNil(){this.writeU8(192)}encodeBoolean(e){!1===e?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<0x100000000?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-0x80000000?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<0x100000000)this.writeU8(219),this.writeU32(e);else throw Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let t=function(e){let t=e.length,s=0,n=0;for(;n<t;){let i=e.charCodeAt(n++);if((0xffffff80&i)==0){s++;continue}if((0xfffff800&i)==0)s+=2;else{if(i>=55296&&i<=56319&&n<t){let t=e.charCodeAt(n);(64512&t)==56320&&(++n,i=((1023&i)<<10)+(1023&t)+65536)}(0xffff0000&i)==0?s+=3:s+=4}}return s}(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),function(e,t,s){if(e.length>50)m.encodeInto(e,t.subarray(s));else!function(e,t,s){let n=e.length,i=s,o=0;for(;o<n;){let s=e.charCodeAt(o++);if((0xffffff80&s)==0){t[i++]=s;continue}if((0xfffff800&s)==0)t[i++]=s>>6&31|192;else{if(s>=55296&&s<=56319&&o<n){let t=e.charCodeAt(o);(64512&t)==56320&&(++o,s=((1023&s)<<10)+(1023&t)+65536)}(0xffff0000&s)==0?t[i++]=s>>12&15|224:(t[i++]=s>>18&7|240,t[i++]=s>>12&63|128),t[i++]=s>>6&63|128}t[i++]=63&s|128}}(e,t,s)}(e,this.bytes,this.pos),this.pos+=t}encodeObject(e,t){let s=this.extensionCodec.tryToEncode(e,this.context);if(null!=s)this.encodeExtension(s);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if("object"==typeof e)this.encodeMap(e,t);else throw Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<0x100000000)this.writeU8(198),this.writeU32(t);else throw Error(`Too large binary: ${t}`);let s=b(e);this.writeU8a(s)}encodeArray(e,t){let s=e.length;if(s<16)this.writeU8(144+s);else if(s<65536)this.writeU8(220),this.writeU16(s);else if(s<0x100000000)this.writeU8(221),this.writeU32(s);else throw Error(`Too large array: ${s}`);for(let s of e)this.doEncode(s,t+1)}countWithoutUndefined(e,t){let s=0;for(let n of t)void 0!==e[n]&&s++;return s}encodeMap(e,t){let s=Object.keys(e);this.sortKeys&&s.sort();let n=this.ignoreUndefined?this.countWithoutUndefined(e,s):s.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else if(n<0x100000000)this.writeU8(223),this.writeU32(n);else throw Error(`Too large map object: ${n}`);for(let n of s){let s=e[n];this.ignoreUndefined&&void 0===s||(this.encodeString(n),this.doEncode(s,t+1))}}encodeExtension(e){if("function"==typeof e.data){let t=e.data(this.pos+6),s=t.length;if(s>=0x100000000)throw Error(`Too large extension object: ${s}`);this.writeU8(201),this.writeU32(s),this.writeI8(e.type),this.writeU8a(t);return}let t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<0x100000000)this.writeU8(201),this.writeU32(t);else throw Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){var t,s;this.ensureBufferSizeToWrite(8),t=this.view,s=this.pos,t.setUint32(s,e/0x100000000),t.setUint32(s+4,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),g(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}}function S(e,t){return new E(t).encodeSharedRef(e)}function C(e){return`${e<0?"-":""}0x${Math.abs(e).toString(16).padStart(2,"0")}`}class U{constructor(e=16,t=16){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let e=0;e<this.maxKeyLength;e++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,s){let n=this.caches[s-1];e:for(let i of n){let n=i.bytes;for(let i=0;i<s;i++)if(n[i]!==e[t+i])continue e;return i.str}return null}store(e,t){let s=this.caches[e.length-1],n={bytes:e,str:t};s.length>=this.maxLengthPerKey?s[Math.random()*s.length|0]=n:s.push(n)}decode(e,t,s){let n=this.find(e,t,s);if(null!=n)return this.hit++,n;this.miss++;let i=w(e,t,s),o=Uint8Array.prototype.slice.call(e,t,t+s);return this.store(o,i),i}}let k="array",x="map_key",M="map_value",B=e=>{if("string"==typeof e||"number"==typeof e)return e;throw new u("The type of key must be string or number but "+typeof e)};class I{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){let t=this.getUninitializedStateFromPool();t.type=k,t.position=0,t.size=e,t.array=Array(e)}pushMapState(e){let t=this.getUninitializedStateFromPool();t.type=x,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){return this.stackHeadPosition++,this.stackHeadPosition===this.stack.length&&this.stack.push({type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null}),this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw Error("Invalid stack state. Released state is not on top of the stack.");e.type===k&&(e.size=0,e.array=void 0,e.position=0,e.type=void 0),(e.type===x||e.type===M)&&(e.size=0,e.map=void 0,e.readCount=0,e.type=void 0),this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}let T=new DataView(new ArrayBuffer(0)),L=new Uint8Array(T.buffer);try{T.getInt8(0)}catch(e){if(!(e instanceof RangeError))throw Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}let _=RangeError("Insufficient data"),H=new U;class ${constructor(e){this.totalPos=0,this.pos=0,this.view=T,this.bytes=L,this.headByte=-1,this.stack=new I,this.entered=!1,this.extensionCodec=e?.extensionCodec??y.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.rawStrings=e?.rawStrings??!1,this.maxStrLength=e?.maxStrLength??0xffffffff,this.maxBinLength=e?.maxBinLength??0xffffffff,this.maxArrayLength=e?.maxArrayLength??0xffffffff,this.maxMapLength=e?.maxMapLength??0xffffffff,this.maxExtLength=e?.maxExtLength??0xffffffff,this.keyDecoder=e?.keyDecoder!==void 0?e.keyDecoder:H,this.mapKeyConverter=e?.mapKeyConverter??B}clone(){return new $({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=-1,this.stack.reset()}setBuffer(e){let t=b(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(-1!==this.headByte||this.hasRemaining(1)){let t=this.bytes.subarray(this.pos),s=b(e),n=new Uint8Array(t.length+s.length);n.set(t),n.set(s,t.length),this.setBuffer(n)}else this.setBuffer(e)}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){let{view:t,pos:s}=this;return RangeError(`Extra ${t.byteLength-s} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);let t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){let t=this.clone();yield*t.decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{let t;this.entered=!0;let s=!1;for await(let n of e){if(s)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(n);try{t=this.doDecodeSync(),s=!0}catch(e){if(!(e instanceof RangeError))throw e}this.totalPos+=this.pos}if(s){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return t}let{headByte:n,pos:i,totalPos:o}=this;throw RangeError(`Insufficient data in parsing ${C(n)} at ${o} (${i} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async *decodeMultiAsync(e,t){if(this.entered){let s=this.clone();yield*s.decodeMultiAsync(e,t);return}try{this.entered=!0;let s=t,n=-1;for await(let i of e){if(t&&0===n)throw this.createExtraByteError(this.totalPos);this.appendBuffer(i),s&&(n=this.readArraySize(),s=!1,this.complete());try{for(;yield this.doDecodeSync(),0!=--n;);}catch(e){if(!(e instanceof RangeError))throw e}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){t:for(;;){let e,t=this.readHeadByte();if(t>=224)e=t-256;else if(t<192)if(t<128)e=t;else if(t<144){let s=t-128;if(0!==s){this.pushMapState(s),this.complete();continue}e={}}else if(t<160){let s=t-144;if(0!==s){this.pushArrayState(s),this.complete();continue}e=[]}else{let s=t-160;e=this.decodeString(s,0)}else if(192===t)e=null;else if(194===t)e=!1;else if(195===t)e=!0;else if(202===t)e=this.readF32();else if(203===t)e=this.readF64();else if(204===t)e=this.readU8();else if(205===t)e=this.readU16();else if(206===t)e=this.readU32();else if(207===t)e=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===t)e=this.readI8();else if(209===t)e=this.readI16();else if(210===t)e=this.readI32();else if(211===t)e=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===t){let t=this.lookU8();e=this.decodeString(t,1)}else if(218===t){let t=this.lookU16();e=this.decodeString(t,2)}else if(219===t){let t=this.lookU32();e=this.decodeString(t,4)}else if(220===t){let t=this.readU16();if(0!==t){this.pushArrayState(t),this.complete();continue}e=[]}else if(221===t){let t=this.readU32();if(0!==t){this.pushArrayState(t),this.complete();continue}e=[]}else if(222===t){let t=this.readU16();if(0!==t){this.pushMapState(t),this.complete();continue}e={}}else if(223===t){let t=this.readU32();if(0!==t){this.pushMapState(t),this.complete();continue}e={}}else if(196===t){let t=this.lookU8();e=this.decodeBinary(t,1)}else if(197===t){let t=this.lookU16();e=this.decodeBinary(t,2)}else if(198===t){let t=this.lookU32();e=this.decodeBinary(t,4)}else if(212===t)e=this.decodeExtension(1,0);else if(213===t)e=this.decodeExtension(2,0);else if(214===t)e=this.decodeExtension(4,0);else if(215===t)e=this.decodeExtension(8,0);else if(216===t)e=this.decodeExtension(16,0);else if(199===t){let t=this.lookU8();e=this.decodeExtension(t,1)}else if(200===t){let t=this.lookU16();e=this.decodeExtension(t,2)}else if(201===t){let t=this.lookU32();e=this.decodeExtension(t,4)}else throw new u(`Unrecognized type byte: ${C(t)}`);this.complete();let s=this.stack;for(;s.length>0;){let t=s.top();if(t.type===k)if(t.array[t.position]=e,t.position++,t.position===t.size)e=t.array,s.release(t);else continue t;else if(t.type===x){if("__proto__"===e)throw new u("The key __proto__ is not allowed");t.key=this.mapKeyConverter(e),t.type=M;continue t}else if(t.map[t.key]=e,t.readCount++,t.readCount===t.size)e=t.map,s.release(t);else{t.key=null,t.type=x;continue t}}return e}}readHeadByte(){return -1===this.headByte&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=-1}readArraySize(){let e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new u(`Unrecognized array type byte: ${C(e)}`)}}pushMapState(e){if(e>this.maxMapLength)throw new u(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new u(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){let s;if(e>this.maxStrLength)throw new u(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw _;let n=this.pos+t;return s=this.stateIsMapKey()&&this.keyDecoder?.canBeCached(e)?this.keyDecoder.decode(this.bytes,n,e):function(e,t,s){if(!(s>200))return w(e,t,s);let n=e.subarray(t,t+s);return v.decode(n)}(this.bytes,n,e),this.pos+=t+e,s}stateIsMapKey(){return this.stack.length>0&&this.stack.top().type===x}decodeBinary(e,t){if(e>this.maxBinLength)throw new u(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw _;let s=this.pos+t,n=this.bytes.subarray(s,s+e);return this.pos+=t+e,n}decodeExtension(e,t){if(e>this.maxExtLength)throw new u(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);let s=this.view.getInt8(this.pos+t),n=this.decodeBinary(e,t+1);return this.extensionCodec.decode(n,s,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){let e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){let e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){let e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){let e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){let e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){var e,t;let s=(e=this.view,t=this.pos,0x100000000*e.getUint32(t)+e.getUint32(t+4));return this.pos+=8,s}readI64(){let e=f(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){let e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){let e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){let e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){let e=this.view.getFloat64(this.pos);return this.pos+=8,e}}function A(e,t){return new $(t).decode(e)}var O=s(97858),R=s(16128),D={RetriesExceeded:"conn_retry_exceeded",HandshakeFailed:"handshake_failed",MessageOrderingViolated:"message_ordering_violated",InvalidMessage:"invalid_message",MessageSendFailure:"message_send_failure"},N=class{eventListeners={};removeAllListeners(){this.eventListeners={}}numberOfListeners(e){return this.eventListeners[e]?.size??0}addEventListener(e,t){this.eventListeners[e]||(this.eventListeners[e]=new Set),this.eventListeners[e]?.add(t)}removeEventListener(e,t){this.eventListeners[e]&&this.eventListeners[e]?.delete(t)}dispatchEvent(e,t){let s=this.eventListeners[e];if(s)for(let e of[...s])e(t)}},Z=new TextEncoder,F=new TextDecoder,P={heartbeatIntervalMs:1e3,heartbeatsUntilDead:2,sessionDisconnectGraceMs:5e3,connectionTimeoutMs:2e3,handshakeTimeoutMs:1e3,enableTransparentSessionReconnects:!0,codec:{toBuffer:e=>Z.encode(JSON.stringify(e,function(e){let t=this[e];if(t instanceof Uint8Array){let e;return{$t:(e="",t.forEach(t=>{e+=String.fromCharCode(t)}),btoa(e))}}return"bigint"==typeof t?{$b:t.toString()}:t})),fromBuffer:e=>{let t=JSON.parse(F.decode(e),function(e,t){return t?.$t!==void 0?function(e){let t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s}(t.$t):t?.$b!==void 0?BigInt(t.$b):t});if("object"!=typeof t||null===t)throw Error("unpacked msg is not an object");return t}}},q={...P,baseIntervalMs:150,maxJitterMs:200,maxBackoffMs:32e3,attemptBudgetCapacity:5,budgetRestoreIntervalMs:200,isFatalConnectionError:()=>!1},j=(e=>(e.NoConnection="NoConnection",e.BackingOff="BackingOff",e.Connecting="Connecting",e.Handshaking="Handshaking",e.Connected="Connected",e.WaitingForHandshake="WaitingForHandshake",e))(j||{}),z="session state has been consumed and is no longer valid",V=class{_isConsumed;close(){this._handleClose()}constructor(){return this._isConsumed=!1,new Proxy(this,{get(e,t){if("_isConsumed"===t||"id"===t||"state"===t)return Reflect.get(e,t);if("_handleStateExit"===t)return()=>{e._isConsumed=!0,e._handleStateExit()};if("_handleClose"===t)return()=>{e._isConsumed=!0,e._handleStateExit(),e._handleClose()};if(e._isConsumed)throw Error(`${z}: getting ${t.toString()} on consumed state`);return Reflect.get(e,t)},set(e,t,s){if(e._isConsumed)throw Error(`${z}: setting ${t.toString()} on consumed state`);return Reflect.set(e,t,s)}})}},G=class extends V{from;options;codec;tracer;log;constructor({from:e,options:t,log:s,tracer:n,codec:i}){super(),this.from=e,this.options=t,this.log=s,this.tracer=n,this.codec=i}},K=class extends G{id;telemetry;to;protocolVersion;seq;seqSent;ack;sendBuffer;constructor(e){let{id:t,to:s,seq:n,ack:i,sendBuffer:o,telemetry:r,log:a,protocolVersion:h,seqSent:l}=e;super(e),this.id=t,this.to=s,this.seq=n,this.ack=i,this.sendBuffer=o,this.telemetry=r,this.log=a,this.protocolVersion=h,this.seqSent=l}get loggingMetadata(){let e={clientId:this.from,connectedTo:this.to,sessionId:this.id};if(this.telemetry.span.isRecording()){let t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}constructMsg(e){let t={...e,id:(0,l.$C)(),to:this.to,from:this.from,seq:this.seq,ack:this.ack};return this.seq++,t}nextSeq(){return this.sendBuffer.length>0?this.sendBuffer[0].seq:this.seq}send(e){let t=this.constructMsg(e);return this.sendBuffer.push(t),{ok:!0,value:t.id}}_handleStateExit(){}_handleClose(){this.sendBuffer.length=0,this.telemetry.span.end()}},W=class extends K{graceExpiryTime;gracePeriodTimeout;listeners;constructor(e){super(e),this.listeners=e.listeners,this.graceExpiryTime=e.graceExpiryTime,this.gracePeriodTimeout=setTimeout(()=>{this.listeners.onSessionGracePeriodElapsed()},this.graceExpiryTime-Date.now())}_handleStateExit(){super._handleStateExit(),this.gracePeriodTimeout&&(clearTimeout(this.gracePeriodTimeout),this.gracePeriodTimeout=void 0)}_handleClose(){super._handleClose()}};function J(e,t,s){let n=t.toBuffer(s);return n.ok?e.send(n.value)?{ok:!0,value:s.id}:{ok:!1,reason:"failed to send message"}:n}var Y=class extends W{state="Connecting";connPromise;listeners;connectionTimeout;constructor(e){super(e),this.connPromise=e.connPromise,this.listeners=e.listeners,this.connPromise.then(e=>{this._isConsumed||this.listeners.onConnectionEstablished(e)},e=>{this._isConsumed||this.listeners.onConnectionFailed(e)}),this.connectionTimeout=setTimeout(()=>{this.listeners.onConnectionTimeout()},this.options.connectionTimeoutMs)}bestEffortClose(){let e=this.log,t=this.loggingMetadata;this.connPromise.then(s=>{s.close(),e?.info("connection eventually resolved but session has transitioned, closed connection",{...t,...s.loggingMetadata})}).catch(()=>{})}_handleStateExit(){super._handleStateExit(),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0)}_handleClose(){super._handleClose(),this.bestEffortClose()}},Q=class extends W{state="NoConnection";_handleClose(){super._handleClose()}_handleStateExit(){super._handleStateExit()}},X=class extends G{state="WaitingForHandshake";conn;listeners;handshakeTimeout;constructor(e){super(e),this.conn=e.conn,this.listeners=e.listeners,this.handshakeTimeout=setTimeout(()=>{this.listeners.onHandshakeTimeout()},this.options.handshakeTimeoutMs),this.conn.setDataListener(this.onHandshakeData),this.conn.setErrorListener(this.listeners.onConnectionErrored),this.conn.setCloseListener(this.listeners.onConnectionClosed)}get loggingMetadata(){return{clientId:this.from,connId:this.conn.id,...this.conn.loggingMetadata}}onHandshakeData=e=>{let t=this.codec.fromBuffer(e);if(!t.ok)return void this.listeners.onInvalidHandshake(`could not parse handshake message: ${t.reason}`,"MALFORMED_HANDSHAKE");this.listeners.onHandshake(t.value)};sendHandshake(e){return J(this.conn,this.codec,e)}_handleStateExit(){this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0}_handleClose(){this.conn.close()}},ee=class extends W{state="Handshaking";conn;listeners;handshakeTimeout;constructor(e){super(e),this.conn=e.conn,this.listeners=e.listeners,this.handshakeTimeout=setTimeout(()=>{this.listeners.onHandshakeTimeout()},this.options.handshakeTimeoutMs),this.conn.setDataListener(this.onHandshakeData),this.conn.setErrorListener(this.listeners.onConnectionErrored),this.conn.setCloseListener(this.listeners.onConnectionClosed)}get loggingMetadata(){return{...super.loggingMetadata,...this.conn.loggingMetadata}}onHandshakeData=e=>{let t=this.codec.fromBuffer(e);if(!t.ok)return void this.listeners.onInvalidHandshake(`could not parse handshake message: ${t.reason}`,"MALFORMED_HANDSHAKE");this.listeners.onHandshake(t.value)};sendHandshake(e){return J(this.conn,this.codec,e)}_handleStateExit(){super._handleStateExit(),this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),this.handshakeTimeout&&(clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0)}_handleClose(){super._handleClose(),this.conn.close()}},et=class extends K{state="Connected";conn;listeners;heartbeatHandle;heartbeatMissTimeout;isActivelyHeartbeating=!1;updateBookkeeping(e,t){this.sendBuffer=this.sendBuffer.filter(t=>t.seq>=e),this.ack=t+1,this.heartbeatMissTimeout&&clearTimeout(this.heartbeatMissTimeout),this.startMissingHeartbeatTimeout()}assertSendOrdering(e){if(e.seq>this.seqSent+1){let t=`invariant violation: would have sent out of order msg (seq: ${e.seq}, expected: ${this.seqSent} + 1)`;throw this.log?.error(t,{...this.loggingMetadata,transportMessage:e,tags:["invariant-violation"]}),Error(t)}}send(e){let t=this.constructMsg(e);this.assertSendOrdering(t),this.sendBuffer.push(t);let s=J(this.conn,this.codec,t);return s.ok?this.seqSent=t.seq:this.listeners.onMessageSendFailure(t,s.reason),s}constructor(e){super(e),this.conn=e.conn,this.listeners=e.listeners,this.conn.setDataListener(this.onMessageData),this.conn.setCloseListener(this.listeners.onConnectionClosed),this.conn.setErrorListener(this.listeners.onConnectionErrored)}sendBufferedMessages(){if(this.sendBuffer.length>0)for(let e of(this.log?.info(`sending ${this.sendBuffer.length} buffered messages, starting at seq ${this.nextSeq()}`,this.loggingMetadata),this.sendBuffer)){this.assertSendOrdering(e);let t=J(this.conn,this.codec,e);if(!t.ok)return this.listeners.onMessageSendFailure(e,t.reason),t;this.seqSent=e.seq}return{ok:!0,value:void 0}}get loggingMetadata(){return{...super.loggingMetadata,...this.conn.loggingMetadata}}startMissingHeartbeatTimeout(){let e=this.options.heartbeatsUntilDead,t=e*this.options.heartbeatIntervalMs;this.heartbeatMissTimeout=setTimeout(()=>{this.log?.info(`closing connection to ${this.to} due to inactivity (missed ${e} heartbeats which is ${t}ms)`,this.loggingMetadata),this.telemetry.span.addEvent("closing connection due to missing heartbeat"),this.conn.close()},t)}startActiveHeartbeat(){this.isActivelyHeartbeating=!0,this.heartbeatHandle=setInterval(()=>{this.sendHeartbeat()},this.options.heartbeatIntervalMs)}sendHeartbeat(){this.log?.debug("sending heartbeat",this.loggingMetadata),this.send({streamId:"heartbeat",controlFlags:1,payload:{type:"ACK"}})}onMessageData=e=>{let t=this.codec.fromBuffer(e);if(!t.ok)return void this.listeners.onInvalidMessage(`could not parse message: ${t.reason}`);let s=t.value;if(s.seq!==this.ack){if(s.seq<this.ack)this.log?.debug(`received duplicate msg (got seq: ${s.seq}, wanted seq: ${this.ack}), discarding`,{...this.loggingMetadata,transportMessage:s});else{let e=`received out-of-order msg, closing connection (got seq: ${s.seq}, wanted seq: ${this.ack})`;this.log?.error(e,{...this.loggingMetadata,transportMessage:s,tags:["invariant-violation"]}),this.telemetry.span.setStatus({code:d.s.ERROR,message:e}),this.conn.close()}return}if(this.log?.debug("received msg",{...this.loggingMetadata,transportMessage:s}),this.updateBookkeeping(s.ack,s.seq),!(0,l.o0)(s.controlFlags))return void this.listeners.onMessage(s);this.log?.debug("discarding msg (ack bit set)",{...this.loggingMetadata,transportMessage:s}),this.isActivelyHeartbeating||this.sendHeartbeat()};_handleStateExit(){super._handleStateExit(),this.conn.removeDataListener(),this.conn.removeCloseListener(),this.conn.removeErrorListener(),this.heartbeatHandle&&(clearInterval(this.heartbeatHandle),this.heartbeatHandle=void 0),this.heartbeatMissTimeout&&(clearTimeout(this.heartbeatMissTimeout),this.heartbeatMissTimeout=void 0)}_handleClose(){super._handleClose(),this.conn.close()}},es=class extends W{state="BackingOff";listeners;backoffTimeout;constructor(e){super(e),this.listeners=e.listeners,this.backoffTimeout=setTimeout(()=>{this.listeners.onBackoffFinished()},e.backoffMs)}_handleClose(){super._handleClose()}_handleStateExit(){super._handleStateExit(),this.backoffTimeout&&(clearTimeout(this.backoffTimeout),this.backoffTimeout=void 0)}},en=new y;en.register({type:0,encode:e=>"bigint"!=typeof e?null:e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?S(Number(e)):S(String(e)),decode(e){let t=A(e);if("string"!=typeof t&&"number"!=typeof t)throw new u(`unexpected BigInt source: ${typeof t}`);return BigInt(t)}});var ei={toBuffer:e=>S(e,{ignoreUndefined:!0,extensionCodec:en}),fromBuffer:e=>{let t=A(e,{extensionCodec:en});if("object"!=typeof t||null===t)throw Error("unpacked msg is not an object");return t}},eo=class{constructor(e){this.codec=e}toBuffer(e){try{return{ok:!0,value:this.codec.toBuffer(e)}}catch(e){return{ok:!1,reason:(0,l.xH)(e)}}}fromBuffer(e){try{let t=this.codec.fromBuffer(e);if(!O.J(l.bH,t))return{ok:!1,reason:"transport message schema mismatch"};return{ok:!0,value:t}}catch(e){return{ok:!1,reason:(0,l.xH)(e)}}}};function er(e){return{id:e.id,from:e.from,to:e.to,seq:e.seq,ack:e.ack,seqSent:e.seqSent,sendBuffer:e.sendBuffer,telemetry:e.telemetry,options:e.options,log:e.log,tracer:e.tracer,protocolVersion:e.protocolVersion,codec:e.codec}}function ea(e){return{...er(e),graceExpiryTime:e.graceExpiryTime}}var eh={entrypoints:{NoConnection:(e,t,s,n,i,o,r)=>{let a=`session-${(0,l.$C)()}`,h=(0,l.iH)(o,a,e,t),d=new Q({listeners:s,id:a,from:t,to:e,seq:0,ack:0,seqSent:0,graceExpiryTime:Date.now()+n.sessionDisconnectGraceMs,sendBuffer:[],telemetry:h,options:n,protocolVersion:i,tracer:o,log:r,codec:new eo(n.codec)});return d.log?.info(`session ${d.id} created in NoConnection state`,{...d.loggingMetadata,tags:["state-transition"]}),d},WaitingForHandshake:(e,t,s,n,i,o)=>{let r=new X({conn:t,listeners:s,from:e,options:n,tracer:i,log:o,codec:new eo(n.codec)});return r.log?.info("session created in WaitingForHandshake state",{...r.loggingMetadata,tags:["state-transition"]}),r}},transition:{NoConnectionToBackingOff:(e,t,s)=>{let n=ea(e);e._handleStateExit();let i=new es({backoffMs:t,listeners:s,...n});return i.log?.info(`session ${i.id} transition from NoConnection to BackingOff`,{...i.loggingMetadata,tags:["state-transition"]}),i},BackingOffToConnecting:(e,t,s)=>{let n=ea(e);e._handleStateExit();let i=new Y({connPromise:t,listeners:s,...n});return i.log?.info(`session ${i.id} transition from BackingOff to Connecting`,{...i.loggingMetadata,tags:["state-transition"]}),i},ConnectingToHandshaking:(e,t,s)=>{let n=ea(e);e._handleStateExit();let i=new ee({conn:t,listeners:s,...n});return t.telemetry=(0,l._I)(i.tracer,t,i.telemetry),i.log?.info(`session ${i.id} transition from Connecting to Handshaking`,{...i.loggingMetadata,tags:["state-transition"]}),i},HandshakingToConnected:(e,t)=>{let s=er(e),n=e.conn;e._handleStateExit();let i=new et({conn:n,listeners:t,...s});return i.startMissingHeartbeatTimeout(),i.log?.info(`session ${i.id} transition from Handshaking to Connected`,{...i.loggingMetadata,tags:["state-transition"]}),i},WaitingForHandshakeToConnected:(e,t,s,n,i,o,r)=>{let a=e.conn,{from:h,options:d}=e,c=t?er(t):{id:s,from:h,to:n,seq:0,ack:0,seqSent:0,sendBuffer:[],telemetry:(0,l.iH)(e.tracer,s,n,h,i),options:d,tracer:e.tracer,log:e.log,protocolVersion:r,codec:new eo(d.codec)};e._handleStateExit(),t?._handleStateExit();let u=new et({conn:a,listeners:o,...c});return u.startMissingHeartbeatTimeout(),a.telemetry=(0,l._I)(u.tracer,a,u.telemetry),u.log?.info(`session ${u.id} transition from WaitingForHandshake to Connected`,{...u.loggingMetadata,tags:["state-transition"]}),u},BackingOffToNoConnection:(e,t)=>{let s=ea(e);e._handleStateExit();let n=new Q({listeners:t,...s});return n.log?.info(`session ${n.id} transition from BackingOff to NoConnection`,{...n.loggingMetadata,tags:["state-transition"]}),n},ConnectingToNoConnection:(e,t)=>{let s=ea(e);e.bestEffortClose(),e._handleStateExit();let n=new Q({listeners:t,...s});return n.log?.info(`session ${n.id} transition from Connecting to NoConnection`,{...n.loggingMetadata,tags:["state-transition"]}),n},HandshakingToNoConnection:(e,t)=>{let s=ea(e);e.conn.close(),e._handleStateExit();let n=new Q({listeners:t,...s});return n.log?.info(`session ${n.id} transition from Handshaking to NoConnection`,{...n.loggingMetadata,tags:["state-transition"]}),n},ConnectedToNoConnection:(e,t)=>{let s=er(e),n=Date.now()+e.options.sessionDisconnectGraceMs;e.conn.close(),e._handleStateExit();let i=new Q({listeners:t,graceExpiryTime:n,...s});return i.log?.info(`session ${i.id} transition from Connected to NoConnection`,{...i.loggingMetadata,tags:["state-transition"]}),i}}},el=eh.transition,ed={entrypoint:eh.entrypoints.NoConnection,transition:{NoConnectionToBackingOff:el.NoConnectionToBackingOff,BackingOffToConnecting:el.BackingOffToConnecting,ConnectingToHandshaking:el.ConnectingToHandshaking,HandshakingToConnected:el.HandshakingToConnected,BackingOffToNoConnection:el.BackingOffToNoConnection,ConnectingToNoConnection:el.ConnectingToNoConnection,HandshakingToNoConnection:el.HandshakingToNoConnection,ConnectedToNoConnection:el.ConnectedToNoConnection}},ec=(eh.entrypoints.WaitingForHandshake,el.WaitingForHandshakeToConnected,el.ConnectedToNoConnection,class{status;clientId;eventDispatcher;options;log;tracer;sessions;constructor(e,t){this.options={...P,...t},this.eventDispatcher=new N,this.clientId=e,this.status="open",this.sessions=new Map,this.tracer=(0,l.EK)()}bindLogger(e,t){if("function"==typeof e){this.log=h(new a(e,t));return}this.log=h(e)}handleMsg(e){"open"===this.getStatus()&&this.eventDispatcher.dispatchEvent("message",e)}addEventListener(e,t){this.eventDispatcher.addEventListener(e,t)}removeEventListener(e,t){this.eventDispatcher.removeEventListener(e,t)}protocolError(e){this.eventDispatcher.dispatchEvent("protocolError",e)}close(){for(let e of(this.status="closed",Array.from(this.sessions.values())))this.deleteSession(e);this.eventDispatcher.dispatchEvent("transportStatus",{status:this.status}),this.eventDispatcher.removeAllListeners(),this.log?.info("manually closed transport",{clientId:this.clientId})}getStatus(){return this.status}createSession(e){let t=this.sessions.get(e.to);if(t){let s=`attempt to create session for ${e.to} but active session (${t.id}) already exists`;throw this.log?.error(s,{...e.loggingMetadata,tags:["invariant-violation"]}),Error(s)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"created",session:e}),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}updateSession(e){let t=this.sessions.get(e.to);if(!t){let t=`attempt to transition session for ${e.to} but no active session exists`;throw this.log?.error(t,{...e.loggingMetadata,tags:["invariant-violation"]}),Error(t)}if(t.id!==e.id){let s=`attempt to transition active session for ${e.to} but active session (${t.id}) is different from handle (${e.id})`;throw this.log?.error(s,{...e.loggingMetadata,tags:["invariant-violation"]}),Error(s)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}deleteSession(e,t){if(e._isConsumed)return;let s=e.loggingMetadata;s.tags&&t?.unhealthy&&s.tags.push("unhealthy-session"),e.log?.info(`closing session ${e.id}`,s),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closing",session:e});let n=e.to;e.close(),this.sessions.delete(n),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closed",session:{id:e.id,to:n}})}onSessionGracePeriodElapsed(e){this.log?.info(`session to ${e.to} grace period elapsed, closing`,e.loggingMetadata),this.deleteSession(e)}onConnectingFailed(e){let t=eh.transition.ConnectingToNoConnection(e,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}});return this.updateSession(t),t}onConnClosed(e){let t;return t="Handshaking"===e.state?eh.transition.HandshakingToNoConnection(e,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}}):eh.transition.ConnectedToNoConnection(e,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}}),this.updateSession(t),t}getSessionBoundSendFn(e,t){if("open"!==this.getStatus())throw Error("cannot get a bound send function on a closed transport");return s=>{let n=this.sessions.get(e);if(!n)throw Error(`session scope for ${t} has ended (close), can't send`);if(n.id!==t||n._isConsumed)throw Error(`session scope for ${t} has ended (transition), can't send`);let i=n.send(s);if(!i.ok)throw Error(i.reason);return i.value}}}),eu=class{budgetConsumed;intervalHandle;options;constructor(e){this.options=e,this.budgetConsumed=0}getBackoffMs(){if(0===this.getBudgetConsumed())return 0;let e=Math.max(0,this.getBudgetConsumed()-1),t=Math.floor(Math.random()*this.options.maxJitterMs);return Math.min(this.options.baseIntervalMs*2**e,this.options.maxBackoffMs)+t}get totalBudgetRestoreTime(){return this.options.budgetRestoreIntervalMs*this.options.attemptBudgetCapacity}consumeBudget(){this.stopLeak(),this.budgetConsumed=this.getBudgetConsumed()+1}getBudgetConsumed(){return this.budgetConsumed}hasBudget(){return this.getBudgetConsumed()<this.options.attemptBudgetCapacity}startRestoringBudget(){if(this.intervalHandle)return;let e=()=>{let e=this.budgetConsumed;if(!e)return void this.stopLeak();let t=e-1;0!==t&&(this.budgetConsumed=t)};this.intervalHandle=setInterval(e,this.options.budgetRestoreIntervalMs)}stopLeak(){this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=void 0)}close(){this.stopLeak()}},eg=class extends ec{options;retryBudget;reconnectOnConnectionDrop=!0;handshakeExtensions;sessions;constructor(e,t){super(e,t),this.sessions=new Map,this.options={...q,...t},this.retryBudget=new eu(this.options)}extendHandshake(e){this.handshakeExtensions=e}tryReconnecting(e){let t=this.sessions.get(e);!this.options.enableTransparentSessionReconnects&&t&&this.deleteSession(t),this.reconnectOnConnectionDrop&&"open"===this.getStatus()&&this.connect(e)}createUnconnectedSession(e){let t=ed.entrypoint(e,this.clientId,{onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(t)}},this.options,l.mH,this.tracer,this.log);return this.createSession(t),t}onConnectingFailed(e){let t=super.onConnectingFailed(e);return this.tryReconnecting(t.to),t}onConnClosed(e){let t=super.onConnClosed(e);return this.tryReconnecting(t.to),t}onConnectionEstablished(e,t){let s=ed.transition.ConnectingToHandshaking(e,t,{onConnectionErrored:e=>{let t=(0,l.xH)(e);this.log?.error(`connection to ${s.to} errored during handshake: ${t}`,s.loggingMetadata)},onConnectionClosed:()=>{this.log?.warn(`connection to ${s.to} closed during handshake`,s.loggingMetadata),this.onConnClosed(s)},onHandshake:e=>{this.onHandshakeResponse(s,e)},onInvalidHandshake:(t,n)=>{this.log?.error(`invalid handshake: ${t}`,s.loggingMetadata),this.deleteSession(e,{unhealthy:!0}),this.protocolError({type:D.HandshakeFailed,code:n,message:t})},onHandshakeTimeout:()=>{this.log?.error(`connection to ${s.to} timed out during handshake`,s.loggingMetadata),this.onConnClosed(s)},onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(s)}});return this.updateSession(s),this.sendHandshake(s),s}rejectHandshakeResponse(e,t,s){e.conn.telemetry?.span.setStatus({code:d.s.ERROR,message:t}),this.log?.warn(t,s),this.deleteSession(e,{unhealthy:!0})}onHandshakeResponse(e,t){if(!O.J(l.O9,t.payload))return void this.rejectHandshakeResponse(e,"received invalid handshake response",{...e.loggingMetadata,transportMessage:t,validationErrors:[...R.I(l.O9,t.payload)]});if(!t.payload.status.ok){let s=O.J(l.Bi,t.payload.status.code),n=`handshake failed: ${t.payload.status.reason}`,i=e.to;this.rejectHandshakeResponse(e,n,{...e.loggingMetadata,transportMessage:t}),s?this.tryReconnecting(i):this.protocolError({type:D.HandshakeFailed,code:t.payload.status.code,message:n});return}if(t.payload.status.sessionId!==e.id){let s=`session id mismatch: expected ${e.id}, got ${t.payload.status.sessionId}`;this.rejectHandshakeResponse(e,s,{...e.loggingMetadata,transportMessage:t});return}this.log?.info(`handshake from ${t.from} ok`,{...e.loggingMetadata,transportMessage:t});let s=ed.transition.HandshakingToConnected(e,{onConnectionErrored:e=>{let t=(0,l.xH)(e);e instanceof Error&&this.options.isFatalConnectionError(e)?(this.log?.warn(`connection to ${s.to} fatally errored: ${t}`,s.loggingMetadata),this.reconnectOnConnectionDrop=!1):this.log?.warn(`connection to ${s.to} errored: ${t}`,s.loggingMetadata)},onConnectionClosed:()=>{this.log?.info(`connection to ${s.to} closed`,s.loggingMetadata),this.onConnClosed(s)},onMessage:e=>{this.handleMsg(e)},onInvalidMessage:e=>{this.log?.error(`invalid message: ${e}`,{...s.loggingMetadata,transportMessage:t}),this.protocolError({type:D.InvalidMessage,message:e}),this.deleteSession(s,{unhealthy:!0})},onMessageSendFailure:(e,t)=>{this.log?.error(`failed to send message: ${t}`,{...s.loggingMetadata,transportMessage:e}),this.protocolError({type:D.MessageSendFailure,message:t}),this.deleteSession(s,{unhealthy:!0})}});s.sendBufferedMessages().ok&&(this.updateSession(s),this.retryBudget.startRestoringBudget())}connect(e){if("open"!==this.getStatus())return void this.log?.info(`transport state is no longer open, cancelling attempt to connect to ${e}`);let t=this.sessions.get(e)??this.createUnconnectedSession(e);if("NoConnection"!==t.state)return void this.log?.debug(`session to ${e} has state ${t.state}, skipping connect attempt`,t.loggingMetadata);if(!this.retryBudget.hasBudget()){let s=this.retryBudget.getBudgetConsumed(),n=`tried to connect to ${e} but retry budget exceeded (more than ${s} attempts in the last ${this.retryBudget.totalBudgetRestoreTime}ms)`;this.log?.error(n,t.loggingMetadata),this.protocolError({type:D.RetriesExceeded,message:n});return}let s=this.retryBudget.getBackoffMs();this.log?.info(`attempting connection to ${e} (${s}ms backoff)`,t.loggingMetadata),this.retryBudget.consumeBudget();let n=ed.transition.NoConnectionToBackingOff(t,s,{onBackoffFinished:()=>{this.onBackoffFinished(n)},onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(n)}});this.updateSession(n)}hardDisconnect(){for(let e of Array.from(this.sessions.values()))this.deleteSession(e)}onBackoffFinished(e){let t=e.tracer.startActiveSpan("connect",async t=>{try{return await this.createNewOutgoingConnection(e.to)}catch(s){let e=(0,l.xH)(s);throw t.recordException(e),t.setStatus({code:d.s.ERROR}),s}finally{t.end()}}),s=ed.transition.BackingOffToConnecting(e,t,{onConnectionEstablished:e=>{this.log?.debug(`connection to ${s.to} established`,{...e.loggingMetadata,...s.loggingMetadata}),this.onConnectionEstablished(s,e)},onConnectionFailed:e=>{let t=(0,l.xH)(e);this.log?.error(`error connecting to ${s.to}: ${t}`,s.loggingMetadata),this.onConnectingFailed(s)},onConnectionTimeout:()=>{this.log?.error(`connection to ${s.to} timed out`,s.loggingMetadata),this.onConnectingFailed(s)},onSessionGracePeriodElapsed:()=>{this.onSessionGracePeriodElapsed(s)}});this.updateSession(s)}async sendHandshake(e){let t;if(this.handshakeExtensions&&(t=await this.handshakeExtensions.construct()),e._isConsumed)return;let s=(0,l.sE)({from:this.clientId,to:e.to,sessionId:e.id,expectedSessionState:{nextExpectedSeq:e.ack,nextSentSeq:e.nextSeq()},metadata:t,tracing:(0,l.oG)(e.telemetry.ctx)});this.log?.debug(`sending handshake request to ${e.to}`,{...e.loggingMetadata,transportMessage:s});let n=e.sendHandshake(s);n.ok||(this.log?.error(`failed to send handshake request: ${n.reason}`,{...e.loggingMetadata,transportMessage:s}),this.protocolError({type:D.MessageSendFailure,message:n.reason}),this.deleteSession(e,{unhealthy:!0}))}close(){this.retryBudget.close(),super.close()}},ef=class{id;telemetry;constructor(){this.id=`conn-${(0,l.$C)()}`}get loggingMetadata(){let e={connId:this.id};if(this.telemetry?.span.isRecording()){let t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}dataListener;closeListener;errorListener;onData(e){this.dataListener?.(e)}onError(e){this.errorListener?.(e)}onClose(){this.closeListener?.(),this.telemetry?.span.end()}setDataListener(e){this.dataListener=e}removeDataListener(){this.dataListener=void 0}setCloseListener(e){this.closeListener=e}removeCloseListener(){this.closeListener=void 0}setErrorListener(e){this.errorListener=e}removeErrorListener(){this.errorListener=void 0}},ep=class extends Error{code;reason;constructor(e,t){super(`websocket closed with code and reason: ${e} - ${t}`),this.code=e,this.reason=t}},ey=class extends ef{ws;extras;get loggingMetadata(){let e=super.loggingMetadata;return this.extras&&(e.extras=this.extras),e}constructor(e,t){super(),this.ws=e,this.extras=t,this.ws.binaryType="arraybuffer";let s=!1;this.ws.onerror=()=>{s=!0},this.ws.onclose=({code:e,reason:t})=>{if(s){let s=new ep(e,t);this.onError(s)}this.onClose()},this.ws.onmessage=e=>{this.onData(e.data)}}send(e){try{return this.ws.send(e),!0}catch{return!1}}close(){this.ws.close(1e3)}}},97268:(e,t,s)=>{s.d(t,{I:()=>i});var n=s(81044),i=class extends n.xp{wsGetter;constructor(e,t,s){super(t,s),this.wsGetter=e}async createNewOutgoingConnection(e){this.log?.info(`establishing a new websocket to ${e}`,{clientId:this.clientId,connectedTo:e});let t=await this.wsGetter(e);await new Promise((e,s)=>t.readyState===t.OPEN?void e():t.readyState===t.CLOSING||t.readyState===t.CLOSED?void s(Error("ws is closing or closed")):void(t.onopen=()=>{e()},t.onclose=e=>{s(Error(e.reason))},t.onerror=e=>{s(Error(e.message))}));let s=new n.Yb(t);return this.log?.info(`raw websocket to ${e} ok`,{clientId:this.clientId,connectedTo:e,...s.loggingMetadata}),s}}}}]);
//# sourceMappingURL=7268-0668df6a7b4fe7ae.js.map